# Lab8 文件系统实验讲义 - 第一部分：概述与学习路线

> **版本**：v1.0  
> **适用对象**：零基础学习者 / 答辩复习者  
> **预计学习时间**：整体实验约 8-12 小时

---

## 一、学习路线图 \[C01]

欢迎来到操作系统实验的最后一站——**文件系统（File System）**！这是一个将你之前所学融会贯通的实验。在开始之前，让我们先了解整体学习路线：

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    Lab8 文件系统学习路线图                               │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  第1阶段：理解基础概念（约2小时）                                         │
│  ├── 什么是文件系统？为什么需要它？                                       │
│  ├── 虚拟文件系统（VFS）的设计思想                                        │
│  └── UNIX文件系统的核心抽象：superblock, inode, dentry, file             │
│                                                                         │
│  第2阶段：掌握ucore文件系统架构（约2小时）                                │
│  ├── 四层架构：用户接口层 → VFS层 → SFS层 → 设备层                        │
│  ├── 关键数据结构及其关系                                                 │
│  └── 初始化流程：fs_init → vfs_init → dev_init → sfs_init               │
│                                                                         │
│  第3阶段：深入SFS文件系统（约2小时）                                      │
│  ├── 磁盘布局：superblock | root-dir | freemap | data blocks            │
│  ├── 索引节点：直接索引 + 一级间接索引                                    │
│  └── 目录项与文件查找机制                                                 │
│                                                                         │
│  第4阶段：理解设备抽象（约1小时）                                         │
│  ├── stdin/stdout/disk0 设备文件                                         │
│  └── "一切皆文件"的设计思想                                               │
│                                                                         │
│  第5阶段：完成练习（约3-5小时）                                           │
│  ├── 练习1：实现 sfs_io_nolock() 读写文件                                │
│  └── 练习2：实现 load_icode() 从文件加载程序                              │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```
\[Fig·C01-1] 学习路线图：从概念到实践的五个阶段

---

## 二、核心知识图（依赖关系）\[C02]

在深入细节之前，先建立整体认知。下面是Lab8的知识依赖图：

```
                        ┌─────────────────────┐
                        │   用户程序 (sh.c)    │
                        │  open/read/write    │
                        └─────────┬───────────┘
                                  │ 系统调用
                                  ▼
                        ┌─────────────────────┐
                        │  通用文件访问接口层   │
                        │  sysfile_open/read  │
                        └─────────┬───────────┘
                                  │
                                  ▼
                        ┌─────────────────────┐
                        │   文件系统抽象层     │
                        │  VFS (inode_ops)    │ ◄─── 统一不同文件系统的接口
                        └─────────┬───────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
            ┌───────────┐  ┌───────────┐  ┌───────────┐
            │   SFS层   │  │  stdin设备 │  │ stdout设备│
            │ (硬盘文件) │  │   (键盘)   │  │  (控制台) │
            └─────┬─────┘  └───────────┘  └───────────┘
                  │
                  ▼
            ┌───────────┐
            │  disk0设备 │ ◄─── 模拟硬盘（ramdisk）
            └───────────┘
```
\[Fig·C02-1] ucore文件系统四层架构与依赖关系

---

## 三、实验目的与内容概览 \[S01]

### 3.1 实验目的

通过本实验，你将：

| 目标编号 | 学习目标 | 对应知识点 |
|---------|---------|-----------|
| 1 | 了解文件系统抽象层 VFS 的设计与实现 | 虚拟文件系统、inode_ops |
| 2 | 了解 Simple FS 文件系统的设计与实现 | 索引节点、目录结构、磁盘布局 |
| 3 | 理解"一切皆文件"的设备文件设计 | stdin/stdout/disk0 设备 |
| 4 | 了解简单终端的实现 | 控制台输入输出 |

\[Fig·C02-2] 实验目标与知识点对应表

### 3.2 与之前实验的关系 \[S01]

> **重要提示**：Lab8 依赖 Lab2/3/4/5/6/7 的代码！

Lab8 在 Lab7（同步互斥）的基础上增加了：
1. **文件系统模块**（kern/fs/ 目录下的所有代码）
2. **通过文件系统加载可执行文件**的功能
3. **进程管理相关代码的调整**（proc.c 中增加了 `fs_struct` 成员）

```c
// kern/process/proc.h 中新增的成员
struct proc_struct {
    // ... 之前的成员 ...
    struct files_struct *filesp;  // 新增：进程的文件结构
};
```

### 3.3 练习任务清单 \[S01]

| 练习 | 任务描述 | 难度 | 预计时间 |
|-----|---------|------|---------|
| 练习0 | 填写 Lab2-7 的代码 | ★☆☆ | 30分钟 |
| 练习1 | 完成 `sfs_io_nolock()` 函数 | ★★★ | 2-3小时 |
| 练习2 | 完成 `load_icode()` 函数 | ★★★ | 2-3小时 |
| Challenge1 | 设计 PIPE 机制（可选） | ★★★★ | - |
| Challenge2 | 设计软/硬链接机制（可选） | ★★★★ | - |

---

## 四、项目结构速览 \[S01]

### 4.1 新增的核心目录：kern/fs/

```
kern/fs/                          ← 文件系统核心代码
├── file.c/h                      ← file 结构体与操作
├── fs.c/h                        ← 文件系统总入口
├── iobuf.c/h                     ← IO 缓冲区
├── sysfile.c/h                   ← 系统调用接口层
├── devs/                         ← 设备文件
│   ├── dev.c/h                   ← 设备抽象
│   ├── dev_disk0.c               ← 磁盘设备
│   ├── dev_stdin.c               ← 标准输入设备
│   └── dev_stdout.c              ← 标准输出设备
├── sfs/                          ← Simple File System
│   ├── sfs.c/h                   ← SFS 入口
│   ├── sfs_fs.c                  ← SFS 文件系统操作
│   ├── sfs_inode.c               ← SFS inode 操作 ← 【练习1在此】
│   ├── sfs_io.c                  ← SFS IO 操作
│   └── bitmap.c/h                ← 位图管理
├── swap/                         ← 交换文件系统
│   └── swapfs.c/h
└── vfs/                          ← 虚拟文件系统
    ├── vfs.c/h                   ← VFS 入口
    ├── inode.c/h                 ← inode 抽象
    ├── vfsdev.c                  ← 设备管理
    ├── vfsfile.c                 ← 文件操作
    ├── vfslookup.c               ← 路径查找
    └── vfspath.c                 ← 路径处理
```

### 4.2 关键文件标注

| 文件路径 | 重要性 | 说明 |
|---------|-------|------|
| `kern/fs/sfs/sfs_inode.c` | ★★★★★ | 练习1：实现 `sfs_io_nolock()` |
| `kern/process/proc.c` | ★★★★★ | 练习2：实现 `load_icode()` |
| `kern/fs/sfs/sfs.h` | ★★★★ | SFS 数据结构定义 |
| `kern/fs/vfs/inode.h` | ★★★★ | VFS inode 接口定义 |
| `kern/fs/file.h` | ★★★ | file 结构体定义 |
| `tools/mksfs.c` | ★★★ | 理解 SFS 磁盘布局的好帮手 |

---

## 五、文件系统初始化流程 \[S01]

当 ucore 启动时，文件系统的初始化流程如下：

```
kern_init()
    │
    └──► fs_init()                    ← 文件系统初始化总入口
           │
           ├──► vfs_init()            ← 初始化 VFS
           │      └── 建立设备链表 vdev_list
           │
           ├──► dev_init()            ← 初始化设备
           │      ├── stdin_device_init()   ← 初始化键盘设备
           │      ├── stdout_device_init()  ← 初始化控制台设备
           │      └── disk0_device_init()   ← 初始化磁盘设备
           │
           └──► sfs_init()            ← 初始化 SFS
                  └── 挂载 SFS 到 VFS
```
\[Fig·C02-3] 文件系统初始化调用链

**关键理解**：
1. `vfs_init()` 建立了一个设备双向链表 `vdev_list`
2. `dev_init()` 将三个设备（stdin/stdout/disk0）抽象成文件，加入链表
3. `sfs_init()` 将 Simple FS 挂载到 VFS，使得上层可以通过统一接口访问硬盘

---

## 六、答辩准备要点 \[C03]

在答辩时，老师可能会问到以下问题。请确保理解：

### 概念类问题
1. **什么是虚拟文件系统（VFS）？它解决了什么问题？**
2. **解释 inode、dentry、file、superblock 四个概念及其关系**
3. **"一切皆文件"是什么意思？ucore 中如何体现？**

### 实现类问题
1. **`sfs_io_nolock()` 函数的作用是什么？你是如何实现的？**
2. **解释 SFS 的直接索引和间接索引机制**
3. **`load_icode()` 函数与 Lab5 的实现有什么不同？**

### 流程类问题
1. **描述 `open()` 系统调用的完整执行流程**
2. **描述 `read()` 系统调用的完整执行流程**
3. **文件系统是如何初始化的？**

---

## 七、自测题 \[C04]

完成本部分学习后，请尝试回答：

**Q1（判断题）**：在 ucore 中，标准输入（stdin）和标准输出（stdout）不是文件。
> **答案**：❌ 错误。在 ucore 中，stdin 和 stdout 都被抽象为设备文件，可以通过文件系统的统一接口访问。

**Q2（单选题）**：以下哪个函数负责将 SFS 文件系统挂载到 VFS？
- A) vfs_init()
- B) dev_init()
- C) sfs_init()
- D) fs_init()

> **答案**：C) sfs_init()。虽然 fs_init() 是总入口，但实际挂载工作由 sfs_init() 完成。

**Q3（开放题）**：为什么需要虚拟文件系统？直接使用具体文件系统不行吗？
> **答案要点**：
> 1. **统一接口**：不同文件系统（如 Ext4、FAT32、SFS）的实现细节不同，VFS 提供统一的 open/read/write 接口
> 2. **易于扩展**：添加新的文件系统时，只需实现 VFS 定义的接口，上层代码无需修改
> 3. **设备抽象**：可以将设备（如键盘、磁盘）也抽象为文件，实现"一切皆文件"

---

## 八、下一步

恭喜你完成了概述部分的学习！接下来请阅读：

📖 **[02_文件系统基础概念.md](02_文件系统基础概念.md)** - 深入理解文件系统的核心概念

---

**Covered**: S01（实验目的、内容、项目组成、初始化流程）

