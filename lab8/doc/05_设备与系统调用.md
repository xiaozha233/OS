# Lab8 æ–‡ä»¶ç³»ç»Ÿå®éªŒè®²ä¹‰ - ç¬¬äº”éƒ¨åˆ†ï¼šè®¾å¤‡ä¸ç³»ç»Ÿè°ƒç”¨

> **å‰ç½®çŸ¥è¯†**ï¼šSFS æ–‡ä»¶ç³»ç»Ÿè¯¦è§£ï¼ˆç¬¬å››éƒ¨åˆ†ï¼‰  
> **å­¦ä¹ äº§å‡º**ï¼šç†è§£è®¾å¤‡æ–‡ä»¶çš„æŠ½è±¡ã€stdin/stdout/disk0 çš„å®ç°ã€open/read ç³»ç»Ÿè°ƒç”¨æµç¨‹

---

## ä¸€ã€è®¾å¤‡æŠ½è±¡ \[S06]

### 1.1 "ä¸€åˆ‡çš†æ–‡ä»¶"çš„æ€æƒ³

åœ¨ UNIX è®¾è®¡å“²å­¦ä¸­ï¼Œ**ä¸€åˆ‡çš†æ–‡ä»¶**æ˜¯ä¸€ä¸ªæ ¸å¿ƒç†å¿µï¼š
- æ™®é€šæ–‡ä»¶æ˜¯æ–‡ä»¶
- ç›®å½•æ˜¯ç‰¹æ®Šæ–‡ä»¶
- **è®¾å¤‡ä¹Ÿæ˜¯æ–‡ä»¶**

è¿™æ„å‘³ç€ï¼šç”¨åŒæ ·çš„ `open/read/write/close` æ¥å£ï¼Œå¯ä»¥æ“ä½œæ™®é€šæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ“ä½œè®¾å¤‡ï¼

```c
// è¯»å–æ™®é€šæ–‡ä»¶
int fd1 = open("/home/test.txt", O_RDONLY);
read(fd1, buf, 100);

// è¯»å–é”®ç›˜è¾“å…¥ï¼ˆä¹Ÿæ˜¯ç”¨ readï¼ï¼‰
int fd2 = open("stdin:", O_RDONLY);  // åœ¨ ucore ä¸­
read(fd2, buf, 100);
```

### 1.2 è®¾å¤‡ç»“æ„ä½“

```c
// kern/fs/devs/dev.h
struct device {
    size_t d_blocks;     // è®¾å¤‡æ€»å—æ•°ï¼ˆå­—ç¬¦è®¾å¤‡å¯ä¸º 0ï¼‰
    size_t d_blocksize;  // æ¯å—å¤§å°
    
    // å››ä¸ªæ ¸å¿ƒæ“ä½œå‡½æ•°ï¼ˆå‡½æ•°æŒ‡é’ˆï¼‰
    int (*d_open)(struct device *dev, uint32_t open_flags);
    int (*d_close)(struct device *dev);
    int (*d_io)(struct device *dev, struct iobuf *iob, bool write);
    int (*d_ioctl)(struct device *dev, int op, void *data);
};
```

**æ“ä½œå®å®šä¹‰**ï¼š
```c
#define dop_open(dev, flags)     ((dev)->d_open(dev, flags))
#define dop_close(dev)           ((dev)->d_close(dev))
#define dop_io(dev, iob, write)  ((dev)->d_io(dev, iob, write))
#define dop_ioctl(dev, op, data) ((dev)->d_ioctl(dev, op, data))
```

### 1.3 è®¾å¤‡ä¸ inode çš„å…³è”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          è®¾å¤‡æ–‡ä»¶çš„ inode                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  struct inode {                                                         â”‚
â”‚      union {                                                            â”‚
â”‚          struct device __device_info;  â† è®¾å¤‡ä¿¡æ¯å­˜åœ¨è¿™é‡Œ               â”‚
â”‚          struct sfs_inode __sfs_inode_info;                             â”‚
â”‚      } in_info;                                                         â”‚
â”‚                                                                         â”‚
â”‚      in_type = inode_type_device_info (0x1234)  â† æ ‡è¯†è¿™æ˜¯è®¾å¤‡æ–‡ä»¶      â”‚
â”‚                                                                         â”‚
â”‚      in_ops = &dev_node_ops;  â† è®¾å¤‡ä¸“ç”¨æ“ä½œå‡½æ•°è¡¨                       â”‚
â”‚  }                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
\[FigÂ·S06-1] è®¾å¤‡æ–‡ä»¶çš„ inode ç»“æ„

### 1.4 è®¾å¤‡é“¾è¡¨

```c
// kern/fs/vfs/vfsdev.c
typedef struct {
    const char *devname;      // è®¾å¤‡åï¼ˆ"disk0", "stdin", "stdout"ï¼‰
    struct inode *devnode;    // è®¾å¤‡å¯¹åº”çš„ inode
    struct fs *fs;            // å…³è”çš„æ–‡ä»¶ç³»ç»Ÿï¼ˆå¦‚æœæœ‰ï¼‰
    bool mountable;           // æ˜¯å¦å¯æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ
    list_entry_t vdev_link;   // é“¾è¡¨èŠ‚ç‚¹
} vfs_dev_t;

static list_entry_t vdev_list;     // å…¨å±€è®¾å¤‡é“¾è¡¨
static semaphore_t vdev_list_sem;  // äº’æ–¥è®¿é—®
```

è®¾å¤‡é“¾è¡¨ç»“æ„ï¼š
```
vdev_list (å¤´èŠ‚ç‚¹)
    â”‚
    â”œâ”€â”€â–º vfs_dev_t { devname: "disk0", devnode: ..., mountable: true }
    â”‚
    â”œâ”€â”€â–º vfs_dev_t { devname: "stdin", devnode: ..., mountable: false }
    â”‚
    â””â”€â”€â–º vfs_dev_t { devname: "stdout", devnode: ..., mountable: false }
```
\[FigÂ·S06-2] è®¾å¤‡é“¾è¡¨ç»“æ„

---

## äºŒã€stdin è®¾å¤‡è¯¦è§£ \[S06]

### 2.1 stdin çš„ä½œç”¨

stdinï¼ˆæ ‡å‡†è¾“å…¥ï¼‰ä»£è¡¨é”®ç›˜è¾“å…¥ã€‚åœ¨ ucore ä¸­ï¼š
- åªèƒ½**è¯»å–**ï¼Œä¸èƒ½å†™å…¥
- ä½¿ç”¨**ç¼“å†²åŒº**æš‚å­˜å·²è¾“å…¥ä½†æœªè¢«è¯»å–çš„å­—ç¬¦

### 2.2 å®ç°ä»£ç è§£æ

```c
// kern/fs/devs/dev_stdin.c

#define STDIN_BUFSIZE 4096
static char stdin_buffer[STDIN_BUFSIZE];   // è¾“å…¥ç¼“å†²åŒº
static off_t p_rpos, p_wpos;               // è¯»/å†™ä½ç½®ï¼ˆç¯å½¢ç¼“å†²åŒºï¼‰
static wait_queue_t __wait_queue, *wait_queue = &__wait_queue;  // ç­‰å¾…é˜Ÿåˆ—

// å°†å­—ç¬¦å†™å…¥ stdin ç¼“å†²åŒºï¼ˆç”±ä¸­æ–­å¤„ç†ç¨‹åºè°ƒç”¨ï¼‰
void dev_stdin_write(char c) {
    bool intr_flag;
    local_intr_save(intr_flag);  // å…³ä¸­æ–­
    {
        stdin_buffer[p_wpos % STDIN_BUFSIZE] = c;
        
        // æ£€æŸ¥ç¼“å†²åŒºæ˜¯å¦å·²æ»¡
        if (p_wpos - p_rpos < STDIN_BUFSIZE) {
            p_wpos++;
            
            // å”¤é†’ç­‰å¾…è¯»å–çš„è¿›ç¨‹
            if (!wait_queue_empty(wait_queue)) {
                wakeup_queue(wait_queue, WT_KBD, 1);
            }
        }
    }
    local_intr_restore(intr_flag);  // å¼€ä¸­æ–­
}

// ä» stdin ç¼“å†²åŒºè¯»å–æ•°æ®
static int dev_stdin_read(char *buf, size_t len) {
    int ret = 0;
    bool intr_flag;
    
    while (len > 0) {
        local_intr_save(intr_flag);
        
        if (p_rpos < p_wpos) {
            // æœ‰æ•°æ®å¯è¯»
            *buf = stdin_buffer[p_rpos % STDIN_BUFSIZE];
            p_rpos++;
            local_intr_restore(intr_flag);
            
            buf++;
            len--;
            ret++;
        } else {
            // ç¼“å†²åŒºä¸ºç©ºï¼Œéœ€è¦ç­‰å¾…
            wait_t __wait, *wait = &__wait;
            wait_current_set(wait_queue, wait, WT_KBD);
            local_intr_restore(intr_flag);
            
            schedule();  // è®©å‡º CPUï¼Œç­‰å¾…é”®ç›˜è¾“å…¥
            
            wait_current_del(wait_queue, wait);
        }
    }
    return ret;
}
```

### 2.3 é”®ç›˜è¾“å…¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         é”®ç›˜è¾“å…¥å¤„ç†æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                        â”‚
â”‚  [ç”¨æˆ·æŒ‰é”®]                                                             â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â–¼                                                                 â”‚
â”‚  [æ—¶é’Ÿä¸­æ–­è§¦å‘] â†â”€â”€ åœ¨ QEMU ä¸­æ— æ³•ç›´æ¥è·å–é”®ç›˜ä¸­æ–­ï¼Œå€Ÿç”¨æ—¶é’Ÿä¸­æ–­        â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â–¼                                                                 â”‚
â”‚  interrupt_handler() (trap.c)                                         â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â–¼                                                                 â”‚
â”‚  serial_intr() â†’ cons_intr() â†’ serial_proc_data()                     â”‚
â”‚      â”‚                      â”‚                                          â”‚
â”‚      â”‚                      â””â”€â–º ä» SBI è·å–å­—ç¬¦                        â”‚
â”‚      â–¼                                                                 â”‚
â”‚  cons.buf[cons.wpos++] = c  (console ç¼“å†²åŒº)                           â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â–¼                                                                 â”‚
â”‚  dev_stdin_write(c)  (stdin è®¾å¤‡ç¼“å†²åŒº)                                â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â”œâ”€â–º stdin_buffer[p_wpos++] = c                                   â”‚
â”‚      â”‚                                                                 â”‚
â”‚      â””â”€â–º wakeup_queue() å”¤é†’ç­‰å¾…çš„è¿›ç¨‹                                 â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
\[FigÂ·S06-3] é”®ç›˜è¾“å…¥å¤„ç†æµç¨‹

### 2.4 stdin çš„ IO æ¥å£

```c
static int stdin_io(struct device *dev, struct iobuf *iob, bool write) {
    if (!write) {  // è¯»æ“ä½œ
        int ret;
        if ((ret = dev_stdin_read(iob->io_base, iob->io_resid)) > 0) {
            iob->io_resid -= ret;  // æ›´æ–°å‰©ä½™é•¿åº¦
        }
        return ret;
    }
    return -E_INVAL;  // ä¸æ”¯æŒå†™æ“ä½œ
}
```

---

## ä¸‰ã€stdout è®¾å¤‡è¯¦è§£ \[S06]

### 3.1 stdout çš„ä½œç”¨

stdoutï¼ˆæ ‡å‡†è¾“å‡ºï¼‰ä»£è¡¨æ§åˆ¶å°è¾“å‡ºã€‚åœ¨ ucore ä¸­ï¼š
- åªèƒ½**å†™å…¥**ï¼Œä¸èƒ½è¯»å–
- ç›´æ¥è°ƒç”¨ `cputchar()` è¾“å‡ºå­—ç¬¦

### 3.2 å®ç°ä»£ç è§£æ

```c
// kern/fs/devs/dev_stdout.c

static int stdout_io(struct device *dev, struct iobuf *iob, bool write) {
    if (write) {  // å†™æ“ä½œ
        char *data = iob->io_base;
        for (; iob->io_resid > 0; iob->io_resid--) {
            cputchar(*data++);  // è¾“å‡ºä¸€ä¸ªå­—ç¬¦
        }
        return 0;
    }
    return -E_INVAL;  // ä¸æ”¯æŒè¯»æ“ä½œ
}
```

`cputchar()` æœ€ç»ˆä¼šè°ƒç”¨ SBI æ¥å£å°†å­—ç¬¦å‘é€åˆ°æ§åˆ¶å°ã€‚

---

## å››ã€disk0 è®¾å¤‡è¯¦è§£ \[S06]

### 4.1 disk0 çš„ä½œç”¨

disk0 æ˜¯æ‰¿è½½ SFS æ–‡ä»¶ç³»ç»Ÿçš„ç£ç›˜è®¾å¤‡ã€‚åœ¨ ucore ä¸­ï¼š
- å®é™…ä¸Šæ˜¯ä¸€å—**å†…å­˜åŒºåŸŸï¼ˆramdiskï¼‰**
- æ”¯æŒè¯»å†™æ“ä½œ
- ä»¥**å—**ä¸ºå•ä½è¿›è¡Œ IO

### 4.2 å®ç°ä»£ç è§£æ

```c
// kern/fs/devs/dev_disk0.c

static char *disk0_buffer;       // IO ç¼“å†²åŒº
static semaphore_t disk0_sem;    // äº’æ–¥ä¿¡å·é‡

// è¯»å–æŒ‡å®šå—
static void disk0_read_blks_nolock(uint32_t blkno, uint32_t nblks) {
    int ret;
    uint32_t sectno = blkno * DISK0_BLKN_SECTS;  // è½¬æ¢ä¸ºæ‰‡åŒºå·
    uint32_t nsects = nblks * DISK0_BLKN_SECTS;  // è½¬æ¢ä¸ºæ‰‡åŒºæ•°
    
    // è°ƒç”¨ ramdisk è¯»å–
    if ((ret = ramdisk_read(disk0_buffer, sectno, nsects)) != 0) {
        panic("disk0: read blk failed: %e.\n", ret);
    }
}

// å†™å…¥æŒ‡å®šå—
static void disk0_write_blks_nolock(uint32_t blkno, uint32_t nblks) {
    int ret;
    uint32_t sectno = blkno * DISK0_BLKN_SECTS;
    uint32_t nsects = nblks * DISK0_BLKN_SECTS;
    
    if ((ret = ramdisk_write(disk0_buffer, sectno, nsects)) != 0) {
        panic("disk0: write blk failed: %e.\n", ret);
    }
}

// disk0 çš„ IO æ¥å£
static int disk0_io(struct device *dev, struct iobuf *iob, bool write) {
    off_t offset = iob->io_offset;
    size_t resid = iob->io_resid;
    
    // æ£€æŸ¥å¯¹é½
    uint32_t blkno = offset / DISK0_BLKSIZE;
    uint32_t nblks = resid / DISK0_BLKSIZE;
    
    lock_disk0();
    while (resid > 0) {
        size_t size = DISK0_BLKSIZE;
        if (resid < size) {
            size = resid;
        }
        
        if (write) {
            memcpy(disk0_buffer, iob->io_base, size);
            disk0_write_blks_nolock(blkno, 1);
        } else {
            disk0_read_blks_nolock(blkno, 1);
            memcpy(iob->io_base, disk0_buffer, size);
        }
        
        iob->io_base += size;
        resid -= size;
        blkno++;
    }
    unlock_disk0();
    
    iob->io_resid = 0;
    return 0;
}
```

---

## äº”ã€ç”¨æˆ·ç¨‹åºçš„ stdin/stdout åˆå§‹åŒ– \[S06]

### 5.1 umain.c çš„ä½œç”¨

æ¯ä¸ªç”¨æˆ·ç¨‹åºåœ¨æ‰§è¡Œ `main()` ä¹‹å‰ï¼Œä¼šå…ˆæ‰§è¡Œ `umain()`ï¼š

```c
// user/libs/umain.c

int main(int argc, char *argv[]);

// åˆå§‹åŒ–æ–‡ä»¶æè¿°ç¬¦
static int initfd(int fd2, const char *path, uint32_t open_flags) {
    int fd1, ret;
    
    // æ‰“å¼€è®¾å¤‡æ–‡ä»¶
    if ((fd1 = open(path, open_flags)) < 0) {
        return fd1;
    }
    
    // å¦‚æœ fd1 ä¸æ˜¯æœŸæœ›çš„ fd2ï¼Œåˆ™å¤åˆ¶
    if (fd1 != fd2) {
        close(fd2);
        ret = dup2(fd1, fd2);
        close(fd1);
    }
    return ret;
}

void umain(int argc, char *argv[]) {
    int fd;
    
    // åˆå§‹åŒ– stdin (fd=0)
    if ((fd = initfd(0, "stdin:", O_RDONLY)) < 0) {
        warn("open stdin failed: %e.\n", fd);
    }
    
    // åˆå§‹åŒ– stdout (fd=1)
    if ((fd = initfd(1, "stdout:", O_WRONLY)) < 0) {
        warn("open stdout failed: %e.\n", fd);
    }
    
    // è°ƒç”¨ç”¨æˆ·ç¨‹åºçš„ main å‡½æ•°
    int ret = main(argc, argv);
    exit(ret);
}
```

### 5.2 æ ‡å‡†æ–‡ä»¶æè¿°ç¬¦

| fd | åç§° | å¯¹åº”è®¾å¤‡ | æ‰“å¼€æ¨¡å¼ |
|---|------|---------|---------|
| 0 | stdin | "stdin:" | O_RDONLY |
| 1 | stdout | "stdout:" | O_WRONLY |
| 2 | stderr | "stdout:" | O_WRONLY |

---

## å…­ã€open ç³»ç»Ÿè°ƒç”¨æµç¨‹è¯¦è§£ \[S07]

### 6.1 è°ƒç”¨é“¾æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     open() ç³»ç»Ÿè°ƒç”¨å®Œæ•´æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ç”¨æˆ·æ€                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€                                                                  â”‚
â”‚  open("/test.txt", O_RDONLY)                                           â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  sys_open() â†’ syscall(SYS_open, ...)                                   â”‚
â”‚      â”‚                                                                  â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚      â”‚ ecall ç³»ç»Ÿè°ƒç”¨                                                   â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  å†…æ ¸æ€                                                                  â”‚
â”‚  â”€â”€â”€â”€â”€â”€                                                                  â”‚
â”‚  syscall() (kern/syscall/syscall.c)                                    â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  sys_open() â†’ sysfile_open(path, flags)                                â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ sysfile_open() (kern/fs/sysfile.c)                              â”‚   â”‚
â”‚  â”‚     â”‚                                                            â”‚   â”‚
â”‚  â”‚     â”œâ”€â–º copy_path() å°†è·¯å¾„ä»ç”¨æˆ·ç©ºé—´æ‹·è´åˆ°å†…æ ¸                   â”‚   â”‚
â”‚  â”‚     â”‚                                                            â”‚   â”‚
â”‚  â”‚     â””â”€â–º file_open(path, flags) æ‰“å¼€æ–‡ä»¶                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ file_open() (kern/fs/file.c)                                    â”‚   â”‚
â”‚  â”‚     â”‚                                                            â”‚   â”‚
â”‚  â”‚     â”œâ”€â–º åˆ†é… file ç»“æ„ä½“ï¼ˆä» fd_array ä¸­æ‰¾ç©ºé—²é¡¹ï¼‰               â”‚   â”‚
â”‚  â”‚     â”‚                                                            â”‚   â”‚
â”‚  â”‚     â””â”€â–º vfs_open(path, flags, &node)                            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ vfs_open() (kern/fs/vfs/vfsfile.c)                              â”‚   â”‚
â”‚  â”‚     â”‚                                                            â”‚   â”‚
â”‚  â”‚     â”œâ”€â–º vfs_lookup(path, &node) æŸ¥æ‰¾æ–‡ä»¶å¯¹åº”çš„ inode            â”‚   â”‚
â”‚  â”‚     â”‚                                                            â”‚   â”‚
â”‚  â”‚     â””â”€â–º vop_open(node, flags) è°ƒç”¨å…·ä½“æ–‡ä»¶ç³»ç»Ÿçš„ open          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ vfs_lookup() (kern/fs/vfs/vfslookup.c)                          â”‚   â”‚
â”‚  â”‚     â”‚                                                            â”‚   â”‚
â”‚  â”‚     â”œâ”€â–º get_device() è§£æè·¯å¾„ï¼Œæ‰¾åˆ°è®¾å¤‡å’Œç›¸å¯¹è·¯å¾„               â”‚   â”‚
â”‚  â”‚     â”‚                                                            â”‚   â”‚
â”‚  â”‚     â””â”€â–º vop_lookup(dir, path, &node)                            â”‚   â”‚
â”‚  â”‚             â”‚                                                    â”‚   â”‚
â”‚  â”‚             â””â”€â–º sfs_lookup() (å¯¹äº SFS æ–‡ä»¶)                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  è¿”å›æ–‡ä»¶æè¿°ç¬¦ fd                                                       â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
\[FigÂ·S07-1] open ç³»ç»Ÿè°ƒç”¨å®Œæ•´æµç¨‹

### 6.2 å…³é”®å‡½æ•°ï¼šsysfile_open

```c
// kern/fs/sysfile.c
int sysfile_open(const char *__path, uint32_t open_flags) {
    int ret;
    char *path;
    
    // å°†ç”¨æˆ·ç©ºé—´çš„è·¯å¾„æ‹·è´åˆ°å†…æ ¸ç©ºé—´
    if ((ret = copy_path(&path, __path)) != 0) {
        return ret;
    }
    
    // è°ƒç”¨æ–‡ä»¶å±‚çš„ open
    ret = file_open(path, open_flags);
    
    kfree(path);
    return ret;  // è¿”å› fd æˆ–é”™è¯¯ç 
}
```

### 6.3 å…³é”®å‡½æ•°ï¼šfile_open

```c
// kern/fs/file.c
int file_open(char *path, uint32_t open_flags) {
    bool readable = 0, writable = 0;
    
    // è§£æ open_flags
    switch (open_flags & O_ACCMODE) {
    case O_RDONLY: readable = 1; break;
    case O_WRONLY: writable = 1; break;
    case O_RDWR: readable = writable = 1; break;
    default: return -E_INVAL;
    }
    
    int ret;
    struct file *file;
    
    // åˆ†é…ä¸€ä¸ª file ç»“æ„ä½“
    if ((ret = fd_array_alloc(NO_FD, &file)) != 0) {
        return ret;
    }
    
    // è°ƒç”¨ VFS å±‚æ‰“å¼€æ–‡ä»¶ï¼Œè·å– inode
    struct inode *node;
    if ((ret = vfs_open(path, open_flags, &node)) != 0) {
        fd_array_free(file);
        return ret;
    }
    
    // è®¾ç½® file çš„å±æ€§
    file->pos = 0;
    file->node = node;
    file->readable = readable;
    file->writable = writable;
    fd_array_open(file);
    
    return file->fd;  // è¿”å›æ–‡ä»¶æè¿°ç¬¦
}
```

### 6.4 å…³é”®å‡½æ•°ï¼švfs_lookup

```c
// kern/fs/vfs/vfslookup.c
int vfs_lookup(char *path, struct inode **node_store) {
    int ret;
    struct inode *node;
    
    // è·å–èµ·å§‹ç›®å½•çš„ inodeï¼ˆæ ¹æ®è·¯å¾„æ˜¯å¦ä»¥ "/" å¼€å¤´ï¼‰
    if ((ret = get_device(path, &subpath, &node)) != 0) {
        return ret;
    }
    
    // å¦‚æœ subpath ä¸ºç©ºï¼Œè¯´æ˜å°±æ˜¯è¦æ‰¾è¿™ä¸ªç›®å½•
    if (*subpath == '\0') {
        *node_store = node;
        return 0;
    }
    
    // å¦åˆ™ï¼Œåœ¨ç›®å½•ä¸­æŸ¥æ‰¾
    ret = vop_lookup(node, subpath, node_store);
    vop_ref_dec(node);  // å‡å°‘å¼•ç”¨è®¡æ•°
    
    return ret;
}
```

### 6.5 SFS å±‚çš„ lookup

```c
// kern/fs/sfs/sfs_inode.c
static int
sfs_lookup(struct inode *node, char *path, struct inode **node_store) {
    struct sfs_fs *sfs = fsop_info(vop_fs(node), sfs);
    assert(*path != '\0' && *path != '/');
    
    // å°† VFS çš„ inode è½¬æ¢ä¸º SFS çš„ inode
    vop_ref_inc(node);
    struct sfs_inode *sin = vop_info(node, sfs_inode);
    
    // é€çº§è§£æè·¯å¾„ï¼ˆä¾‹å¦‚ "home/alice/test.txt"ï¼‰
    char *subpath;
    while (1) {
        // è·å–å½“å‰ç›®å½•é¡¹åç§°
        subpath = strchr(path, '/');
        if (subpath != NULL) {
            *subpath = '\0';  // ä¸´æ—¶æˆªæ–­
        }
        
        // åœ¨å½“å‰ç›®å½•ä¸­æŸ¥æ‰¾
        struct inode *subnode;
        int ret = sfs_lookup_once(sfs, sin, path, &subnode, NULL);
        
        vop_ref_dec(node);  // é‡Šæ”¾å½“å‰ç›®å½•
        
        if (ret != 0) {
            return ret;
        }
        
        node = subnode;
        sin = vop_info(node, sfs_inode);
        
        if (subpath == NULL) {
            // æ‰¾åˆ°äº†ç›®æ ‡
            *node_store = node;
            return 0;
        }
        
        path = subpath + 1;  // ç»§ç»­ä¸‹ä¸€çº§
    }
}
```

---

## ä¸ƒã€read ç³»ç»Ÿè°ƒç”¨æµç¨‹è¯¦è§£ \[S07]

### 7.1 è°ƒç”¨é“¾æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     read() ç³»ç»Ÿè°ƒç”¨å®Œæ•´æµç¨‹                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  ç”¨æˆ·æ€: read(fd, buf, len)                                             â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼ (ç³»ç»Ÿè°ƒç”¨)                                                       â”‚
â”‚  å†…æ ¸æ€: sys_read() â†’ sysfile_read(fd, buf, len)                       â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  sysfile_read() (kern/fs/sysfile.c)                                    â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â–º åˆ†é…å†…æ ¸ç¼“å†²åŒº (4KB)                                           â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â–º å¾ªç¯è¯»å–ï¼š                                                     â”‚
â”‚      â”‚       â”œâ”€â–º file_read() è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒº                          â”‚
â”‚      â”‚       â””â”€â–º copy_to_user() æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´                         â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â–º é‡Šæ”¾ç¼“å†²åŒºï¼Œè¿”å›è¯»å–å­—èŠ‚æ•°                                      â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  file_read() (kern/fs/file.c)                                          â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â–º fd2file(fd) è·å– file ç»“æ„ä½“                                  â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â–º åˆ›å»º iobuf ç»“æ„ä½“                                              â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â–º vop_read(file->node, iob) è°ƒç”¨ VFS å±‚è¯»å–                     â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â–º æ›´æ–° file->pos                                                 â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  vop_read() â†’ sfs_read() (å¯¹äº SFS æ–‡ä»¶)                               â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â–¼                                                                  â”‚
â”‚  sfs_io() (kern/fs/sfs/sfs_inode.c)                                    â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â–º lock_sin(sin) åŠ é”                                            â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â”œâ”€â–º sfs_io_nolock() â† ã€ç»ƒä¹ 1 æ ¸å¿ƒå‡½æ•°ã€‘                          â”‚
â”‚      â”‚                                                                  â”‚
â”‚      â””â”€â–º unlock_sin(sin) è§£é”                                          â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
\[FigÂ·S07-2] read ç³»ç»Ÿè°ƒç”¨å®Œæ•´æµç¨‹

### 7.2 å…³é”®å‡½æ•°ï¼šsysfile_read

```c
// kern/fs/sysfile.c
int sysfile_read(int fd, void *base, size_t len) {
    struct mm_struct *mm = current->mm;
    
    // æ£€æŸ¥ç”¨æˆ·ç©ºé—´ç¼“å†²åŒºæ˜¯å¦åˆæ³•
    if (len == 0) {
        return 0;
    }
    if (!file_testfd(fd, 1, 0)) {  // æ£€æŸ¥ fd æ˜¯å¦å¯è¯»
        return -E_INVAL;
    }
    
    // åˆ†é…å†…æ ¸ç¼“å†²åŒº
    void *buffer = kmalloc(IOBUF_SIZE);  // 4KB
    if (buffer == NULL) {
        return -E_NO_MEM;
    }
    
    int ret = 0;
    size_t copied = 0;
    size_t alen;
    
    // å¾ªç¯è¯»å–
    while (len > 0) {
        size_t size = (len < IOBUF_SIZE) ? len : IOBUF_SIZE;
        
        // è¯»å–åˆ°å†…æ ¸ç¼“å†²åŒº
        if ((ret = file_read(fd, buffer, size, &alen)) != 0) {
            goto out;
        }
        if (alen == 0) {  // è¯»åˆ°æ–‡ä»¶æœ«å°¾
            break;
        }
        
        // æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´
        lock_mm(mm);
        if (!copy_to_user(mm, base, buffer, alen)) {
            unlock_mm(mm);
            ret = -E_INVAL;
            goto out;
        }
        unlock_mm(mm);
        
        base += alen;
        len -= alen;
        copied += alen;
    }
    
out:
    kfree(buffer);
    return (ret == 0) ? copied : ret;
}
```

### 7.3 å…³é”®å‡½æ•°ï¼šfile_read

```c
// kern/fs/file.c
int file_read(int fd, void *base, size_t len, size_t *copied_store) {
    int ret;
    struct file *file;
    
    *copied_store = 0;
    
    // è·å– file ç»“æ„ä½“
    if ((ret = fd2file(fd, &file)) != 0) {
        return ret;
    }
    if (!file->readable) {
        return -E_INVAL;
    }
    
    fd_array_acquire(file);  // å¢åŠ å¼•ç”¨è®¡æ•°
    
    // åˆ›å»º iobuf
    struct iobuf __iob, *iob = iobuf_init(&__iob, base, len, file->pos);
    
    // è°ƒç”¨ VFS å±‚è¯»å–
    ret = vop_read(file->node, iob);
    
    size_t copied = iobuf_used(iob);
    if (copied > 0) {
        file->pos += copied;  // æ›´æ–°è¯»å†™ä½ç½®
    }
    *copied_store = copied;
    
    fd_array_release(file);  // å‡å°‘å¼•ç”¨è®¡æ•°
    
    return ret;
}
```

---

## å…«ã€iobuf ç»“æ„ä½“ \[S07]

### 8.1 å®šä¹‰

```c
// kern/fs/iobuf.h
struct iobuf {
    void *io_base;     // ç¼“å†²åŒºåŸºåœ°å€
    off_t io_offset;   // æ–‡ä»¶ä¸­çš„åç§»é‡
    size_t io_len;     // åŸå§‹è¯·æ±‚é•¿åº¦
    size_t io_resid;   // å‰©ä½™å¾…å¤„ç†é•¿åº¦
};
```

### 8.2 ä½¿ç”¨æ–¹å¼

```c
// åˆå§‹åŒ– iobuf
struct iobuf iob;
iobuf_init(&iob, buffer, 1024, file->pos);

// å¤„ç†åï¼Œå·²è¯»å–å­—èŠ‚æ•°
size_t read_bytes = iobuf_used(&iob);  // = io_len - io_resid
```

---

## ä¹ã€æ˜“é”™ç‚¹ \[C11]

### 9.1 å¸¸è§è¯¯åŒº

| è¯¯åŒº | æ­£ç¡®ç†è§£ |
|-----|---------|
| stdin å¯ä»¥å†™å…¥ | âŒ stdin åªèƒ½è¯»å– |
| stdout å¯ä»¥è¯»å– | âŒ stdout åªèƒ½å†™å…¥ |
| file_read ç›´æ¥è¿”å›æ•°æ® | âŒ éœ€è¦é€šè¿‡ç¼“å†²åŒºä¸­è½¬ |
| ç”¨æˆ·ç©ºé—´è·¯å¾„å¯ç›´æ¥ä½¿ç”¨ | âŒ å¿…é¡»å…ˆæ‹·è´åˆ°å†…æ ¸ç©ºé—´ |

### 9.2 è·¯å¾„å­—ç¬¦ä¸²å¤„ç†

ç”¨æˆ·ç©ºé—´ä¼ æ¥çš„è·¯å¾„å­—ç¬¦ä¸²**ä¸èƒ½ç›´æ¥ä½¿ç”¨**ï¼å¿…é¡»ï¼š
1. æ£€æŸ¥ç”¨æˆ·ç©ºé—´åœ°å€æ˜¯å¦åˆæ³•
2. æ‹·è´åˆ°å†…æ ¸ç©ºé—´çš„ç¼“å†²åŒº
3. ä½¿ç”¨å®Œæ¯•åé‡Šæ”¾

---

## åã€è‡ªæµ‹é¢˜ \[C12]

**Q1ï¼ˆå•é€‰é¢˜ï¼‰**ï¼šä»¥ä¸‹å“ªä¸ªæ–‡ä»¶æè¿°ç¬¦å¯¹åº”æ ‡å‡†è¾“å…¥ï¼Ÿ
- A) 0
- B) 1
- C) 2
- D) 3

> **ç­”æ¡ˆ**ï¼šA) 0ã€‚çº¦å®š fd=0 æ˜¯ stdinï¼Œfd=1 æ˜¯ stdoutï¼Œfd=2 æ˜¯ stderrã€‚

**Q2ï¼ˆåˆ¤æ–­é¢˜ï¼‰**ï¼šåœ¨ ucore ä¸­ï¼Œé”®ç›˜æŒ‰é”®åä¼šç«‹å³è§¦å‘é”®ç›˜ä¸­æ–­æ¥å¤„ç†è¾“å…¥ã€‚
> **ç­”æ¡ˆ**ï¼šâŒ é”™è¯¯ã€‚åœ¨ QEMU æ¨¡æ‹Ÿç¯å¢ƒä¸­ï¼Œucore æ— æ³•ç›´æ¥è·å–é”®ç›˜ä¸­æ–­ï¼Œè€Œæ˜¯**å€ŸåŠ©æ—¶é’Ÿä¸­æ–­**æ¥æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„é”®ç›˜è¾“å…¥ã€‚

**Q3ï¼ˆå¼€æ”¾é¢˜ï¼‰**ï¼šè§£é‡Š read ç³»ç»Ÿè°ƒç”¨ä¸ºä»€ä¹ˆéœ€è¦åœ¨å†…æ ¸ä¸­åˆ†é…ç¼“å†²åŒºï¼Œè€Œä¸æ˜¯ç›´æ¥å†™å…¥ç”¨æˆ·ç©ºé—´ï¼Ÿ
> **ç­”æ¡ˆè¦ç‚¹**ï¼š
> 1. æ–‡ä»¶ç³»ç»Ÿå±‚çš„è¯»å–å‡½æ•°å·¥ä½œåœ¨å†…æ ¸æ€ï¼Œä¸èƒ½ç›´æ¥è®¿é—®ç”¨æˆ·ç©ºé—´å†…å­˜
> 2. éœ€è¦å…ˆè¯»åˆ°å†…æ ¸ç¼“å†²åŒºï¼Œå†é€šè¿‡ `copy_to_user` å®‰å…¨åœ°æ‹·è´åˆ°ç”¨æˆ·ç©ºé—´
> 3. è¿™æ ·å¯ä»¥æ£€æŸ¥ç”¨æˆ·ç©ºé—´åœ°å€çš„åˆæ³•æ€§ï¼Œé˜²æ­¢å®‰å…¨é—®é¢˜

---

## åä¸€ã€ä¸‹ä¸€æ­¥

å®Œæˆæœ¬éƒ¨åˆ†åï¼Œä½ å·²ç†è§£äº†è®¾å¤‡æŠ½è±¡å’Œç³»ç»Ÿè°ƒç”¨æµç¨‹ï¼æ¥ä¸‹æ¥è¯·é˜…è¯»ï¼š

ğŸ“– **[06_ç»ƒä¹ 1_sfs_io_nolockå®ç°.md](06_ç»ƒä¹ 1_sfs_io_nolockå®ç°.md)** - å®Œæˆç»ƒä¹ 1çš„è¯¦ç»†æŒ‡å¯¼

---

**Covered**: S06ï¼ˆè®¾å¤‡æŠ½è±¡ã€stdin/stdout/disk0ï¼‰, S07ï¼ˆopen/read ç³»ç»Ÿè°ƒç”¨æµç¨‹ï¼‰
