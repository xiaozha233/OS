# Lab8 æ–‡ä»¶ç³»ç»Ÿå®éªŒè®²ä¹‰ - ç¬¬å…­éƒ¨åˆ†ï¼šç»ƒä¹ 1 sfs_io_nolock å®ç°

> **å‰ç½®çŸ¥è¯†**ï¼šSFS æ–‡ä»¶ç³»ç»Ÿè¯¦è§£ã€ç³»ç»Ÿè°ƒç”¨æµç¨‹  
> **å­¦ä¹ äº§å‡º**ï¼šå®Œæˆ `sfs_io_nolock()` å‡½æ•°ï¼Œå®ç°æ–‡ä»¶è¯»å†™æ“ä½œ

---

## ä¸€ã€ç»ƒä¹ 1 ä»»åŠ¡è¯´æ˜ \[S08]

### 1.1 ä»»åŠ¡æè¿°

> **ç»ƒä¹ 1ï¼šå®Œæˆè¯»æ–‡ä»¶æ“ä½œçš„å®ç°ï¼ˆéœ€è¦ç¼–ç ï¼‰**
>
> é¦–å…ˆäº†è§£æ‰“å¼€æ–‡ä»¶çš„å¤„ç†æµç¨‹ï¼Œç„¶åå‚è€ƒæœ¬å®éªŒåç»­çš„æ–‡ä»¶è¯»å†™æ“ä½œçš„è¿‡ç¨‹åˆ†æï¼Œå¡«å†™åœ¨ `kern/fs/sfs/sfs_inode.c` ä¸­çš„ `sfs_io_nolock()` å‡½æ•°ï¼Œå®ç°è¯»æ–‡ä»¶ä¸­æ•°æ®çš„ä»£ç ã€‚

### 1.2 å‡½æ•°å®šä½

- **æ–‡ä»¶è·¯å¾„**ï¼š`kern/fs/sfs/sfs_inode.c`
- **å‡½æ•°å**ï¼š`sfs_io_nolock()`
- **ä½œç”¨**ï¼šåœ¨ SFS æ–‡ä»¶ç³»ç»Ÿä¸­è¯»å–æˆ–å†™å…¥æ–‡ä»¶æ•°æ®

### 1.3 é¢„æœŸæ•ˆæœ

å®Œæˆåï¼Œè¿è¡Œ `make qemu`ï¼Œå¦‚æœèƒ½å¤Ÿæ­£å¸¸è¿›å…¥ shell å¹¶æ‰§è¡Œæ–‡ä»¶æ“ä½œï¼Œè¯´æ˜ç»ƒä¹ 1å®Œæˆã€‚

---

## äºŒã€å‡½æ•°ä¸Šä¸‹æ–‡åˆ†æ

### 2.1 sfs_io_nolock åœ¨è°ƒç”¨é“¾ä¸­çš„ä½ç½®

```
ç”¨æˆ·ç¨‹åº: read(fd, buf, len)
    â”‚
    â–¼
ç³»ç»Ÿè°ƒç”¨å±‚: sysfile_read()
    â”‚
    â–¼
æ–‡ä»¶å±‚: file_read() â†’ vop_read()
    â”‚
    â–¼
SFSå±‚: sfs_read() â†’ sfs_io()
    â”‚
    â–¼
æ ¸å¿ƒå‡½æ•°: sfs_io_nolock()  â† ã€ä½ éœ€è¦å®Œæˆè¿™ä¸ªå‡½æ•°ã€‘
    â”‚
    â”œâ”€â”€â–º sfs_bmap_load_nolock()  // è·å–æ•°æ®å—çš„ç£ç›˜å—å·
    â”‚
    â”œâ”€â”€â–º sfs_rbuf() / sfs_rblock()  // è¯»å–æ•°æ®
    â”‚
    â””â”€â”€â–º sfs_wbuf() / sfs_wblock()  // å†™å…¥æ•°æ®
```
\[FigÂ·S08-1] sfs_io_nolock åœ¨è°ƒç”¨é“¾ä¸­çš„ä½ç½®

### 2.2 sfs_io å‡½æ•°ï¼ˆåŒ…è£…å‡½æ•°ï¼‰

```c
// sfs_io æ˜¯ sfs_io_nolock çš„åŒ…è£…å‡½æ•°ï¼Œè´Ÿè´£åŠ é”
static inline int
sfs_io(struct inode *node, struct iobuf *iob, bool write) {
    struct sfs_fs *sfs = fsop_info(vop_fs(node), sfs);
    struct sfs_inode *sin = vop_info(node, sfs_inode);
    int ret;
    
    lock_sin(sin);  // åŠ é”
    {
        size_t alen = iob->io_resid;
        ret = sfs_io_nolock(sfs, sin, iob->io_base, iob->io_offset, &alen, write);
        if (alen != 0) {
            iobuf_skip(iob, alen);  // æ›´æ–° iob
        }
    }
    unlock_sin(sin);  // è§£é”
    return ret;
}
```

---

## ä¸‰ã€å‡½æ•°å‚æ•°è¯¦è§£

### 3.1 å‡½æ•°ç­¾å

```c
static int
sfs_io_nolock(struct sfs_fs *sfs, struct sfs_inode *sin, void *buf, 
              off_t offset, size_t *alenp, bool write)
```

### 3.2 å‚æ•°è¯´æ˜

| å‚æ•° | ç±»å‹ | è¯´æ˜ |
|-----|------|------|
| `sfs` | `struct sfs_fs *` | SFS æ–‡ä»¶ç³»ç»Ÿç»“æ„ä½“ |
| `sin` | `struct sfs_inode *` | æ–‡ä»¶çš„ SFS inode |
| `buf` | `void *` | æ•°æ®ç¼“å†²åŒºï¼ˆè¯»æ“ä½œï¼šå†™å…¥ç›®æ ‡ï¼›å†™æ“ä½œï¼šè¯»å–æºï¼‰ |
| `offset` | `off_t` | æ–‡ä»¶å†…çš„èµ·å§‹åç§»é‡ |
| `alenp` | `size_t *` | è¾“å…¥ï¼šè¯·æ±‚é•¿åº¦ï¼›è¾“å‡ºï¼šå®é™…å¤„ç†é•¿åº¦ |
| `write` | `bool` | æ“ä½œç±»å‹ï¼š0=è¯»å–ï¼Œ1=å†™å…¥ |

---

## å››ã€å·²æä¾›çš„ä»£ç æ¡†æ¶åˆ†æ

### 4.1 å‡½æ•°æ¡†æ¶

```c
static int
sfs_io_nolock(struct sfs_fs *sfs, struct sfs_inode *sin, void *buf, 
              off_t offset, size_t *alenp, bool write) {
    struct sfs_disk_inode *din = sin->din;
    assert(din->type != SFS_TYPE_DIR);  // ä¸èƒ½å¯¹ç›®å½•ä½¿ç”¨
    
    off_t endpos = offset + *alenp;     // è®¡ç®—ç»“æŸä½ç½®
    *alenp = 0;
    
    // ========== è¾¹ç•Œæ£€æŸ¥ ==========
    if (offset < 0 || offset >= SFS_MAX_FILE_SIZE || offset > endpos) {
        return -E_INVAL;
    }
    if (offset == endpos) {
        return 0;
    }
    if (endpos > SFS_MAX_FILE_SIZE) {
        endpos = SFS_MAX_FILE_SIZE;
    }
    
    // å¯¹äºè¯»æ“ä½œï¼Œé™åˆ¶åœ¨æ–‡ä»¶å½“å‰å¤§å°å†…
    if (!write) {
        if (offset >= din->size) {
            return 0;
        }
        if (endpos > din->size) {
            endpos = din->size;
        }
    }
    
    // ========== é€‰æ‹©æ“ä½œå‡½æ•° ==========
    int (*sfs_buf_op)(struct sfs_fs *sfs, void *buf, size_t len, 
                      uint32_t blkno, off_t offset);
    int (*sfs_block_op)(struct sfs_fs *sfs, void *buf, 
                        uint32_t blkno, uint32_t nblks);
    if (write) {
        sfs_buf_op = sfs_wbuf;
        sfs_block_op = sfs_wblock;
    } else {
        sfs_buf_op = sfs_rbuf;
        sfs_block_op = sfs_rblock;
    }
    
    int ret = 0;
    size_t size, alen = 0;
    uint32_t ino;
    uint32_t blkno = offset / SFS_BLKSIZE;          // èµ·å§‹å—å·
    uint32_t nblks = endpos / SFS_BLKSIZE - blkno;  // éœ€å¤„ç†çš„å®Œæ•´å—æ•°
    
    // ========== LAB8: ç»ƒä¹ 1 - ä½ éœ€è¦åœ¨æ­¤å®ç° ==========
    // æç¤ºï¼š
    // (1) å¦‚æœ offset ä¸æ˜¯å—å¯¹é½çš„ï¼Œå…ˆå¤„ç†ç¬¬ä¸€ä¸ªå—çš„éƒ¨åˆ†æ•°æ®
    // (2) å¤„ç†ä¸­é—´çš„å®Œæ•´å—
    // (3) å¦‚æœ endpos ä¸æ˜¯å—å¯¹é½çš„ï¼Œå¤„ç†æœ€åä¸€ä¸ªå—çš„éƒ¨åˆ†æ•°æ®
    
out:
    *alenp = alen;
    if (offset + alen > sin->din->size) {
        sin->din->size = offset + alen;
        sin->dirty = 1;
    }
    return ret;
}
```

### 4.2 å…³é”®å˜é‡è§£é‡Š

```
å‡è®¾ï¼šoffset = 5000, è¯·æ±‚é•¿åº¦ = 10000

æ–‡ä»¶æ•°æ®åœ¨ç£ç›˜ä¸Šçš„å¸ƒå±€ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Block 0   â”‚  Block 1   â”‚  Block 2   â”‚  Block 3   â”‚  Block 4   â”‚
â”‚ 0-4095     â”‚ 4096-8191  â”‚ 8192-12287 â”‚ 12288-16383â”‚ 16384-...  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â†‘                              â†‘
              offset=5000                   endpos=15000
              
blkno = 5000 / 4096 = 1      (èµ·å§‹å—å·)
nblks = 15000 / 4096 - 1 = 2 (ä¸­é—´å®Œæ•´å—æ•°ï¼šBlock 2, Block 3)

éœ€è¦å¤„ç†çš„ä¸‰éƒ¨åˆ†ï¼š
1. Block 1 çš„ [904, 4095] éƒ¨åˆ† (4096 - 5000%4096 = 3192 å­—èŠ‚)
2. Block 2, Block 3 å®Œæ•´å— (2 * 4096 = 8192 å­—èŠ‚)  
3. Block 4 çš„ [0, 615] éƒ¨åˆ† (15000 % 4096 = 616 å­—èŠ‚)

ä½†ç­‰ç­‰ï¼nblks = 2ï¼Œè¯´æ˜ Block 2 å’Œ Block 3 æ˜¯å®Œæ•´çš„ä¸­é—´å—
ç„¶è€Œä¸Šé¢çš„åˆ†ææœ‰ç‚¹é—®é¢˜ï¼Œè®©æˆ‘ä»¬é‡æ–°è®¡ç®—ï¼š

blkno = 5000 / 4096 = 1
endpos / SFS_BLKSIZE = 15000 / 4096 = 3
nblks = 3 - 1 = 2

è¿™æ„å‘³ç€ä» Block 1 åˆ° Block 3 ä¹‹é—´æœ‰ 2 ä¸ªå®Œæ•´å—çš„å·®è·
ä½† Block 1 ä¸æ˜¯å®Œæ•´å—ï¼ŒBlock 3 ä¹Ÿä¸æ˜¯å®Œæ•´å—ï¼ˆå› ä¸º endpos åœ¨ Block 3 å†…éƒ¨ï¼‰

å®é™…ä¸Šä»£ç ä¸­ nblks çš„å«ä¹‰æ˜¯ï¼š
- blkno æ˜¯èµ·å§‹å—
- nblks æ˜¯ä»èµ·å§‹å—åˆ°ç»“æŸå—ä¹‹é—´è·¨è¶Šçš„"å®Œæ•´å—æ•°"
```

è®©æˆ‘ç”¨æ›´æ¸…æ™°çš„æ–¹å¼è§£é‡Šï¼š

```
offset = 5000, endpos = 15000, SFS_BLKSIZE = 4096

blkno = offset / SFS_BLKSIZE = 5000 / 4096 = 1
nblks = endpos / SFS_BLKSIZE - blkno = 3 - 1 = 2

blkoff = offset % SFS_BLKSIZE = 5000 % 4096 = 904

æƒ…å†µåˆ†æï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                 â”‚
â”‚   Block 1         Block 2         Block 3         Block 4      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ”‚    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚    â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚       â†‘                                            â†‘           â”‚
â”‚   offset=5000                                 endpos=15000     â”‚
â”‚   blkoff=904                                                   â”‚
â”‚                                                                 â”‚
â”‚   â–ˆ = éœ€è¦å¤„ç†çš„æ•°æ®                                            â”‚
â”‚   â–‘ = ä¸éœ€è¦å¤„ç†çš„æ•°æ®                                          â”‚
â”‚                                                                 â”‚
â”‚   ç¬¬ä¸€å—éƒ¨åˆ†ï¼šBlock 1 çš„ [904, 4095]ï¼Œå¤§å° = 4096 - 904 = 3192  â”‚
â”‚   ä¸­é—´å®Œæ•´å—ï¼šBlock 2, Block 3ï¼ˆnblks = 2ï¼‰                     â”‚
â”‚   æœ€åå—éƒ¨åˆ†ï¼šBlock 4 çš„ [0, 615]ï¼Œå¤§å° = 15000 % 4096 = 616   â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
\[FigÂ·S08-2] æ–‡ä»¶è¯»å†™çš„ä¸‰ç§æƒ…å†µç¤ºæ„å›¾

---

## äº”ã€å®ç°æ€è·¯è¯¦è§£

### 5.1 æ•´ä½“æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   sfs_io_nolock å®ç°æµç¨‹                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Step 1: è®¡ç®—å…³é”®å˜é‡                                                   â”‚
â”‚      blkoff = offset % SFS_BLKSIZE  // èµ·å§‹å—å†…åç§»                     â”‚
â”‚                                                                         â”‚
â”‚  Step 2: å¤„ç†ç¬¬ä¸€ä¸ªå—ï¼ˆå¦‚æœ offset ä¸å¯¹é½ï¼‰                             â”‚
â”‚      if (blkoff != 0) {                                                â”‚
â”‚          size = (nblks != 0) ? (SFS_BLKSIZE - blkoff) : (endpos - offset)â”‚
â”‚          è·å–å—å· â†’ è¯»å†™éƒ¨åˆ†æ•°æ® â†’ æ›´æ–°æŒ‡é’ˆå’Œè®¡æ•°                        â”‚
â”‚      }                                                                  â”‚
â”‚                                                                         â”‚
â”‚  Step 3: å¤„ç†ä¸­é—´çš„å®Œæ•´å—                                               â”‚
â”‚      while (è¿˜æœ‰å®Œæ•´å—) {                                               â”‚
â”‚          è·å–å—å· â†’ è¯»å†™å®Œæ•´å— â†’ æ›´æ–°æŒ‡é’ˆå’Œè®¡æ•°                          â”‚
â”‚      }                                                                  â”‚
â”‚                                                                         â”‚
â”‚  Step 4: å¤„ç†æœ€åä¸€ä¸ªå—ï¼ˆå¦‚æœ endpos ä¸å¯¹é½ï¼‰                           â”‚
â”‚      if (endpos % SFS_BLKSIZE != 0) {                                  â”‚
â”‚          size = endpos % SFS_BLKSIZE                                   â”‚
â”‚          è·å–å—å· â†’ è¯»å†™éƒ¨åˆ†æ•°æ® â†’ æ›´æ–°æŒ‡é’ˆå’Œè®¡æ•°                        â”‚
â”‚      }                                                                  â”‚
â”‚                                                                         â”‚
â”‚  Step 5: æ›´æ–° alenï¼Œè¿”å›                                                â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```
\[FigÂ·S08-3] sfs_io_nolock å®ç°æµç¨‹

### 5.2 éœ€è¦ç”¨åˆ°çš„è¾…åŠ©å‡½æ•°

| å‡½æ•° | ä½œç”¨ | å‚æ•° |
|-----|------|------|
| `sfs_bmap_load_nolock` | è·å–æ–‡ä»¶ç¬¬ index ä¸ªå—çš„ç£ç›˜å—å· | (sfs, sin, index, &ino) |
| `sfs_buf_op` | è¯»/å†™å—çš„ä¸€éƒ¨åˆ† | (sfs, buf, len, blkno, offset) |
| `sfs_block_op` | è¯»/å†™å®Œæ•´å— | (sfs, buf, blkno, nblks) |

---

## å…­ã€åˆ†æ­¥å®ç°æŒ‡å¯¼

### 6.1 Step 1: è®¡ç®—èµ·å§‹å—å†…åç§»

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è®¡ç®— offset åœ¨ç¬¬ä¸€ä¸ªå—å†…çš„åç§»ä½ç½®ï¼š

```c
// åœ¨ uint32_t nblks = ... ä¹‹åæ·»åŠ 
off_t blkoff = offset % SFS_BLKSIZE;  // èµ·å§‹å—å†…åç§»
```

**ç†è§£**ï¼š
- å¦‚æœ `blkoff == 0`ï¼Œè¯´æ˜ offset æ­£å¥½å¯¹é½åˆ°å—è¾¹ç•Œ
- å¦‚æœ `blkoff != 0`ï¼Œè¯´æ˜éœ€è¦å…ˆå¤„ç†ç¬¬ä¸€ä¸ªå—çš„éƒ¨åˆ†æ•°æ®

### 6.2 Step 2: å¤„ç†ç¬¬ä¸€ä¸ªå—ï¼ˆéå¯¹é½æƒ…å†µï¼‰

å½“ `blkoff != 0` æ—¶ï¼Œéœ€è¦å¤„ç†ç¬¬ä¸€ä¸ªå—çš„éƒ¨åˆ†æ•°æ®ï¼š

```c
// æƒ…å†µ1ï¼šç¬¬ä¸€ä¸ªå—ä¸å¯¹é½
if (blkoff != 0) {
    // è®¡ç®—åœ¨ç¬¬ä¸€ä¸ªå—ä¸­éœ€è¦å¤„ç†çš„å¤§å°
    // å¦‚æœè¿˜æœ‰åç»­å—(nblks != 0)ï¼Œåˆ™å¤„ç†åˆ°å—æœ«å°¾
    // å¦‚æœæ²¡æœ‰åç»­å—(nblks == 0)ï¼Œè¯´æ˜æ•°æ®å®Œå…¨åœ¨ç¬¬ä¸€ä¸ªå—å†…ï¼Œåªå¤„ç† endpos - offset
    size = (nblks != 0) ? (SFS_BLKSIZE - blkoff) : (endpos - offset);
    
    // è·å–è¯¥å—çš„ç£ç›˜å—å·
    if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0) {
        goto out;
    }
    
    // è¯»/å†™è¯¥å—çš„éƒ¨åˆ†æ•°æ®
    // sfs_buf_op(sfs, buf, len, blkno, offset_in_block)
    if ((ret = sfs_buf_op(sfs, buf, size, ino, blkoff)) != 0) {
        goto out;
    }
    
    // æ›´æ–°è®¡æ•°å’ŒæŒ‡é’ˆ
    alen += size;
    buf += size;
    
    // å¦‚æœè¿˜æœ‰åç»­å—ï¼Œç§»åŠ¨åˆ°ä¸‹ä¸€å—
    if (nblks > 0) {
        blkno++;
        nblks--;
    }
}
```

**è§£é‡Š**ï¼š
- `sfs_bmap_load_nolock` å°†æ–‡ä»¶çš„é€»è¾‘å—å· `blkno` è½¬æ¢ä¸ºç£ç›˜ç‰©ç†å—å· `ino`
- `sfs_buf_op` è¯»/å†™ç£ç›˜å— `ino` çš„ `[blkoff, blkoff+size)` èŒƒå›´çš„æ•°æ®
- `alen` è®°å½•å·²å¤„ç†çš„å­—èŠ‚æ•°
- `buf` æŒ‡é’ˆå‘å‰ç§»åŠ¨

### 6.3 Step 3: å¤„ç†ä¸­é—´çš„å®Œæ•´å—

æ¥ä¸‹æ¥å¤„ç†ä¸­é—´å¯¹é½çš„å®Œæ•´å—ï¼š

```c
// æƒ…å†µ2ï¼šå¤„ç†ä¸­é—´çš„å®Œæ•´å—
while (nblks > 0) {
    // è·å–è¯¥å—çš„ç£ç›˜å—å·
    if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0) {
        goto out;
    }
    
    // è¯»/å†™å®Œæ•´å—
    // sfs_block_op(sfs, buf, blkno, nblks) - ä¸€æ¬¡è¯»å†™ nblks ä¸ªè¿ç»­å—
    // ä½†è¿™é‡Œæˆ‘ä»¬é€å—å¤„ç†æ›´ç®€å•
    if ((ret = sfs_block_op(sfs, buf, ino, 1)) != 0) {
        goto out;
    }
    
    // æ›´æ–°è®¡æ•°å’ŒæŒ‡é’ˆ
    alen += SFS_BLKSIZE;
    buf += SFS_BLKSIZE;
    blkno++;
    nblks--;
}
```

**ä¼˜åŒ–æ€è·¯**ï¼ˆå¯é€‰ï¼‰ï¼š
å®é™…ä¸Šï¼Œå¦‚æœå¤šä¸ªè¿ç»­å—åœ¨ç£ç›˜ä¸Šä¹Ÿæ˜¯è¿ç»­çš„ï¼Œå¯ä»¥ä¸€æ¬¡æ€§è¯»å†™å¤šå—ã€‚ä½†ä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬é€å—å¤„ç†ã€‚

### 6.4 Step 4: å¤„ç†æœ€åä¸€ä¸ªå—ï¼ˆéå¯¹é½æƒ…å†µï¼‰

æœ€åï¼Œå¦‚æœ endpos ä¸å¯¹é½åˆ°å—è¾¹ç•Œï¼Œéœ€è¦å¤„ç†æœ€åä¸€å—çš„éƒ¨åˆ†æ•°æ®ï¼š

```c
// æƒ…å†µ3ï¼šæœ€åä¸€ä¸ªå—ä¸å¯¹é½
if (endpos % SFS_BLKSIZE != 0) {
    // è®¡ç®—æœ€åä¸€å—éœ€è¦å¤„ç†çš„å¤§å°
    size = endpos % SFS_BLKSIZE;
    
    // è·å–è¯¥å—çš„ç£ç›˜å—å·
    if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0) {
        goto out;
    }
    
    // è¯»/å†™è¯¥å—çš„å‰é¢éƒ¨åˆ†ï¼ˆä»å—èµ·å§‹åˆ° endpos % SFS_BLKSIZEï¼‰
    if ((ret = sfs_buf_op(sfs, buf, size, ino, 0)) != 0) {
        goto out;
    }
    
    // æ›´æ–°è®¡æ•°
    alen += size;
}
```

---

## ä¸ƒã€å®Œæ•´ä»£ç ï¼ˆå¸¦è¯¦ç»†æ³¨é‡Šï¼‰

ä»¥ä¸‹æ˜¯å®Œæ•´çš„å®ç°ä»£ç ã€‚**è¯·å…ˆå°è¯•è‡ªå·±å®ç°ï¼Œå†å¯¹ç…§å‚è€ƒï¼**

```c
static int
sfs_io_nolock(struct sfs_fs *sfs, struct sfs_inode *sin, void *buf, 
              off_t offset, size_t *alenp, bool write) {
    struct sfs_disk_inode *din = sin->din;
    assert(din->type != SFS_TYPE_DIR);
    
    off_t endpos = offset + *alenp;
    *alenp = 0;
    
    // è¾¹ç•Œæ£€æŸ¥
    if (offset < 0 || offset >= SFS_MAX_FILE_SIZE || offset > endpos) {
        return -E_INVAL;
    }
    if (offset == endpos) {
        return 0;
    }
    if (endpos > SFS_MAX_FILE_SIZE) {
        endpos = SFS_MAX_FILE_SIZE;
    }
    
    // è¯»æ“ä½œé™åˆ¶åœ¨æ–‡ä»¶å¤§å°å†…
    if (!write) {
        if (offset >= din->size) {
            return 0;
        }
        if (endpos > din->size) {
            endpos = din->size;
        }
    }
    
    // é€‰æ‹©æ“ä½œå‡½æ•°
    int (*sfs_buf_op)(struct sfs_fs *sfs, void *buf, size_t len, 
                      uint32_t blkno, off_t offset);
    int (*sfs_block_op)(struct sfs_fs *sfs, void *buf, 
                        uint32_t blkno, uint32_t nblks);
    if (write) {
        sfs_buf_op = sfs_wbuf;
        sfs_block_op = sfs_wblock;
    } else {
        sfs_buf_op = sfs_rbuf;
        sfs_block_op = sfs_rblock;
    }
    
    int ret = 0;
    size_t size, alen = 0;
    uint32_t ino;
    uint32_t blkno = offset / SFS_BLKSIZE;
    uint32_t nblks = endpos / SFS_BLKSIZE - blkno;
    
    // ========== ç»ƒä¹ 1 å®ç°å¼€å§‹ ==========
    
    // è®¡ç®—èµ·å§‹å—å†…åç§»
    off_t blkoff = offset % SFS_BLKSIZE;
    
    // æƒ…å†µ1ï¼šå¤„ç†ç¬¬ä¸€ä¸ªä¸å¯¹é½çš„å—
    if (blkoff != 0) {
        // è®¡ç®—éœ€è¦å¤„ç†çš„å¤§å°ï¼š
        // - å¦‚æœè¿˜æœ‰åç»­å—ï¼Œå¤„ç†åˆ°æœ¬å—æœ«å°¾
        // - å¦‚æœæ²¡æœ‰åç»­å—ï¼Œåªå¤„ç† endpos - offset
        size = (nblks != 0) ? (SFS_BLKSIZE - blkoff) : (endpos - offset);
        
        // è·å–ç£ç›˜å—å·
        if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0) {
            goto out;
        }
        
        // è¯»/å†™éƒ¨åˆ†å—
        if ((ret = sfs_buf_op(sfs, buf, size, ino, blkoff)) != 0) {
            goto out;
        }
        
        // æ›´æ–°çŠ¶æ€
        alen += size;
        buf += size;
        if (nblks > 0) {
            blkno++;
            nblks--;
        }
    }
    
    // æƒ…å†µ2ï¼šå¤„ç†ä¸­é—´çš„å®Œæ•´å—
    while (nblks > 0) {
        // è·å–ç£ç›˜å—å·
        if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0) {
            goto out;
        }
        
        // è¯»/å†™å®Œæ•´å—
        if ((ret = sfs_block_op(sfs, buf, ino, 1)) != 0) {
            goto out;
        }
        
        // æ›´æ–°çŠ¶æ€
        alen += SFS_BLKSIZE;
        buf += SFS_BLKSIZE;
        blkno++;
        nblks--;
    }
    
    // æƒ…å†µ3ï¼šå¤„ç†æœ€åä¸€ä¸ªä¸å¯¹é½çš„å—
    if (endpos % SFS_BLKSIZE != 0) {
        // è®¡ç®—æœ€åå—éœ€è¦å¤„ç†çš„å¤§å°
        size = endpos % SFS_BLKSIZE;
        
        // è·å–ç£ç›˜å—å·
        if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0) {
            goto out;
        }
        
        // è¯»/å†™éƒ¨åˆ†å—ï¼ˆä»å—èµ·å§‹å¼€å§‹ï¼‰
        if ((ret = sfs_buf_op(sfs, buf, size, ino, 0)) != 0) {
            goto out;
        }
        
        // æ›´æ–°çŠ¶æ€
        alen += size;
    }
    
    // ========== ç»ƒä¹ 1 å®ç°ç»“æŸ ==========
    
out:
    *alenp = alen;
    if (offset + alen > sin->din->size) {
        sin->din->size = offset + alen;
        sin->dirty = 1;
    }
    return ret;
}
```

---

## å…«ã€è¾¹ç•Œæƒ…å†µåˆ†æ

### 8.1 æƒ…å†µä¸€ï¼šå®Œå…¨åœ¨ä¸€ä¸ªå—å†…

```
offset = 100, len = 200, endpos = 300
blkno = 0, nblks = 0 - 0 = 0
blkoff = 100

åªæ‰§è¡Œæƒ…å†µ1ï¼šå¤„ç† Block 0 çš„ [100, 300)
size = (0 != 0) ? ... : (300 - 100) = 200
```

### 8.2 æƒ…å†µäºŒï¼šè·¨è¶Šå¤šä¸ªå®Œæ•´å—

```
offset = 0, len = 8192, endpos = 8192
blkno = 0, nblks = 2 - 0 = 2
blkoff = 0

blkoff == 0ï¼Œè·³è¿‡æƒ…å†µ1
æ‰§è¡Œæƒ…å†µ2ï¼šå¤„ç† Block 0, Block 1 ä¸¤ä¸ªå®Œæ•´å—
endpos % 4096 == 0ï¼Œè·³è¿‡æƒ…å†µ3
```

### 8.3 æƒ…å†µä¸‰ï¼šä¸‰ç§æƒ…å†µéƒ½æœ‰

```
offset = 1000, len = 10000, endpos = 11000
blkno = 0, nblks = 2 - 0 = 2
blkoff = 1000

æƒ…å†µ1ï¼šBlock 0 çš„ [1000, 4096)ï¼Œsize = 3096
æƒ…å†µ2ï¼šBlock 1, Block 2 å®Œæ•´å—ï¼ˆä½†å…¶å® nblks å˜åŒ–äº†ï¼‰
æƒ…å†µ3ï¼šå¦‚æœæœ‰å‰©ä½™...
```

---

## ä¹ã€è°ƒè¯•å»ºè®®

### 9.1 ç¼–è¯‘æµ‹è¯•

```bash
cd /home/albus_os/labcode/lab8
make clean
make qemu
```

### 9.2 é¢„æœŸè¾“å‡º

å¦‚æœå®ç°æ­£ç¡®ï¼Œåº”è¯¥èƒ½çœ‹åˆ° shell æç¤ºç¬¦ `$`ï¼Œå¹¶ä¸”å¯ä»¥æ‰§è¡Œå‘½ä»¤ï¼š

```
$ ls
hello sh ls ...
$ hello
Hello, world!
```

### 9.3 å¸¸è§é”™è¯¯

| é”™è¯¯ç°è±¡ | å¯èƒ½åŸå›  |
|---------|---------|
| å¯åŠ¨æ—¶ panic | è¾¹ç•Œè®¡ç®—é”™è¯¯ï¼Œå¯¼è‡´è¯»å–è¶Šç•Œ |
| æ–‡ä»¶å†…å®¹é”™è¯¯ | buf æŒ‡é’ˆæ›´æ–°é”™è¯¯ |
| æ— é™å¾ªç¯ | nblks/blkno æ›´æ–°é€»è¾‘é”™è¯¯ |
| éƒ¨åˆ†æ•°æ®ä¸¢å¤± | alen æ›´æ–°ä¸æ­£ç¡® |

---

## åã€è‡ªæµ‹é¢˜ \[C13]

**Q1ï¼ˆåˆ¤æ–­é¢˜ï¼‰**ï¼šåœ¨ `sfs_io_nolock` ä¸­ï¼Œå¦‚æœ offset æ­£å¥½æ˜¯å—çš„èµ·å§‹ä½ç½®ï¼Œå°±ä¸éœ€è¦å¤„ç†"æƒ…å†µ1"ã€‚
> **ç­”æ¡ˆ**ï¼šâœ… æ­£ç¡®ã€‚æ­¤æ—¶ `blkoff = offset % SFS_BLKSIZE = 0`ï¼Œæ¡ä»¶ `blkoff != 0` ä¸ºå‡ï¼Œè·³è¿‡æƒ…å†µ1ã€‚

**Q2ï¼ˆå•é€‰é¢˜ï¼‰**ï¼š`sfs_buf_op` å’Œ `sfs_block_op` çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ
- A) ä¸€ä¸ªç”¨äºè¯»ï¼Œä¸€ä¸ªç”¨äºå†™
- B) ä¸€ä¸ªç”¨äºå¤„ç†éƒ¨åˆ†å—ï¼Œä¸€ä¸ªç”¨äºå¤„ç†å®Œæ•´å—
- C) ä¸€ä¸ªç”¨äºç›´æ¥ç´¢å¼•ï¼Œä¸€ä¸ªç”¨äºé—´æ¥ç´¢å¼•
- D) æ²¡æœ‰åŒºåˆ«

> **ç­”æ¡ˆ**ï¼šB) ä¸€ä¸ªç”¨äºå¤„ç†éƒ¨åˆ†å—ï¼Œä¸€ä¸ªç”¨äºå¤„ç†å®Œæ•´å—ã€‚`sfs_buf_op` å¯ä»¥æŒ‡å®šå—å†…åç§»å’Œé•¿åº¦ï¼Œ`sfs_block_op` å¤„ç†æ•´å—ã€‚

**Q3ï¼ˆä»£ç é¢˜ï¼‰**ï¼šä»¥ä¸‹ä»£ç ç‰‡æ®µæœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ
```c
if ((ret = sfs_bmap_load_nolock(sfs, sin, blkno, &ino)) != 0) {
    return ret;  // ç›´æ¥è¿”å›
}
```
> **ç­”æ¡ˆ**ï¼šä¸åº”è¯¥ç›´æ¥ `return ret`ï¼Œåº”è¯¥ `goto out`ã€‚å› ä¸º `out` æ ‡ç­¾å¤„è¿˜æœ‰åç»­å¤„ç†ï¼ˆæ›´æ–° `*alenp` å’Œæ–‡ä»¶å¤§å°ï¼‰ã€‚

---

## åä¸€ã€ä¸‹ä¸€æ­¥

å®Œæˆç»ƒä¹ 1åï¼Œè¯·ç»§ç»­é˜…è¯»ï¼š

ğŸ“– **[07_ç»ƒä¹ 2_load_icodeå®ç°.md](07_ç»ƒä¹ 2_load_icodeå®ç°.md)** - å®Œæˆç»ƒä¹ 2çš„è¯¦ç»†æŒ‡å¯¼

---

**Covered**: S08ï¼ˆç»ƒä¹ 1 sfs_io_nolock å®ç°ï¼‰
